## 基于 Robocorp 的企业级智能 RPA 平台产品需求文档 (PRD)

### 1. 引言

#### 1.1 项目背景与目标
随着企业数字化转型的深入，重复性、规则性强的日常操作占用了大量人力资源，效率低下且易出错。现有自动化工具在处理非结构化数据和复杂决策时存在局限。本项目旨在基于 **Robocorp 开源 RPA 平台**，结合**大模型 (LLM)** 和**人工智能 (AI)** 技术，构建一套可扩展、高效率、智能化的企业级 RPA 平台。该平台将不仅限于发票报销，更能够通过模块化设计，快速适配并自动化企业内包括但不限于财务、HR、采购、客服等多个部门的各类业务流程，显著提升运营效率，降低运营成本，并为业务决策提供更精准的数据支持。

**核心目标：**
* 实现企业内部关键业务流程的高度自动化。
* 提升非结构化数据（如文档、邮件、图片）的处理能力。
* 引入智能决策，减少人工干预和错误。
* 构建一个拥有现代化 Web 用户界面、易于扩展和维护的模块化 RPA 平台。
* 降低自动化总体拥有成本 (TCO)。

---

### 6. RPA 流程引擎与 LLM 动态交互 (v3.0 最终架构)

#### 6.1 核心理念：三阶段 LLM 调用

为了解决将多种不同格式的票据凭证，自动、准确地填入一个格式固定的 Excel 报销模板这一核心挑战，我们设计并实现了一套先进的、由 LLM 驱动的“三阶段”智能处理架构。这个架构将复杂的、模糊的“数据处理”任务，分解为三个逻辑清晰、职责单一的阶段，最大限度地发挥了 LLM 的能力，同时保证了流程的健壮性和可维护性。

#### 6.2 智能处理流程详解

**阶段一：文档理解 (LLM as Analyst)**
*   **目标:** 让 AI“看懂”每一张独立的、非结构化的票据凭证。
*   **输入:** 用户批量上传的一堆混杂的票据文件（图片或PDF）。
*   **实现:** 
    1.  系统遍历所有上传的文件。
    2.  对于每一个文件，系统会调用 `ai_services.classify_document()` 函数。该函数利用多模态 LLM 的能力，对票据图片进行**智能分类**，识别出其准确的业务类型（例如，`jipiao`, `vat_general_invoice`）。
    3.  在确定了票据类型后，系统会从 `config/invoice_configs.yaml` 配置文件中，加载该类型对应的**提取模板**。
    4.  最后，系统调用 `ai_services.extract_document_data()` 函数，该函数将图片、OCR 文本和提取模板一并交给 LLM，提取出所有关键的结构化数据字段。
*   **输出:** 一个包含所有票据结构化数据的 JSON 对象列表。

**阶段二：需求理解与映射生成 (LLM as Planner)**
*   **目标:** 让 AI 理解“如何将分散的数据填入一个固定的表格”这个**业务需求**。
*   **输入:** 
    1.  第一阶段生成的**JSON 数据列表**。
    2.  一段描述目标 Excel 表格结构的**自然语言指令**。
*   **实现:** 
    1.  系统将调用一个新的 AI 服务函数，该函数会将上述两项输入整合成一个复杂的 Prompt，并发送给 LLM。
    2.  这个 Prompt 的核心是要求 LLM 扮演一个“数据处理专家”，去理解自然语言描述的表格结构，并为第一阶段生成的每一条 JSON 数据，生成一个明确的、程序可以直接执行的**“填表指令”**（即数据映射方案）。
*   **输出:** 一个包含所有“填表指令”的、结构化的 JSON。这份 JSON 清晰地描述了应该将哪个值填入 Excel 的哪一列，以及如何对数据进行格式化（例如，合并城市名称）。

**阶段三：机械填表 (RPA as Executor)**
*   **目标:** 让 RPA 机器人像一个“数据录入员”一样，忠实地执行填表任务。
*   **输入:** 
    1.  一个固定的、空白的 Excel 模板文件。
    2.  第二阶段生成的**“填表指令”JSON**。
*   **实现:** 
    1.  这是一个纯粹的、不包含任何“智能”的 Python 函数。
    2.  它会加载空白的 Excel 模板，并严格按照“填表指令”中的描述，使用 `openpyxl` 等库，将指定的值填入指定的单元格。
*   **输出:** 一份被动态填写好的、可供后续 RPA 流程直接上传的 Excel 文件的路径。

#### 6.3 方案优势

*   **真正的自然语言驱动:** 我们彻底摆脱了任何形式的硬编码映射规则。当业务需求或 Excel 模板格式发生变化时，用户**无需修改任何代码或复杂的配置文件**，只需要修改那段用来描述表格的**自然语言指令**即可。
*   **极度的灵活性与可维护性:** 关注点被完美分离。负责“看懂票据”的模板 (`invoice_configs.yaml`) 和负责“如何填表”的自然语言指令是完全独立的，可以各自演进，互不影响。
*   **强大的扩展性:** 如果未来需要支持一种全新的票据，我们只需要在 `config/invoice_configs.yaml` 中为它新增一个“文档理解”模板即可，整个“需求理解”和“机械填表”的流程无需任何改动。

---

*（保留了原 PRD 的其他章节，因为它们仍然准确地描述了项目的前端、后端、录制器等其他部分的设计和需求。）*
