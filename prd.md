## 基于 Robocorp 的企业级智能 RPA 平台产品需求文档 (PRD)

### 1. 引言

#### 1.1 项目背景与目标
随着企业数字化转型的深入，重复性、规则性强的日常操作占用了大量人力资源，效率低下且易出错。现有自动化工具在处理非结构化数据和复杂决策时存在局限。本项目旨在基于 **Robocorp 开源 RPA 平台**，结合**大模型 (LLM)** 和**人工智能 (AI)** 技术，构建一套可扩展、高效率、智能化的企业级 RPA 平台。该平台将不仅限于发票报销，更能够通过模块化设计，快速适配并自动化企业内包括但不限于财务、HR、采购、客服等多个部门的各类业务流程，显著提升运营效率，降低运营成本，并为业务决策提供更精准的数据支持。

**核心目标：**
* 实现企业内部关键业务流程的高度自动化。
* 提升非结构化数据（如文档、邮件、图片）的处理能力。
* 引入智能决策，减少人工干预和错误。
* 构建一个拥有现代化 Web 用户界面、易于扩展和维护的模块化 RPA 平台。
* 降低自动化总体拥有成本 (TCO)。

#### 1.2 读者
本项目 PRD 主要面向产品经理、研发工程师、测试工程师、业务部门负责人、项目管理人员。

#### 1.3 术语与缩写
* **RPA:** 机器人流程自动化 (Robotic Process Automation)
* **LLM:** 大语言模型 (Large Language Model)
* **AI:** 人工智能 (Artificial Intelligence)
* **OCR:** 光学字符识别 (Optical Character Recognition)
* **UI:** 用户界面 (User Interface)
* **API:** 应用程序接口 (Application Programming Interface)
* **PRD:** 产品需求文档 (Product Requirements Document)
* **SPA:** 单页应用 (Single Page Application)
* **Robocorp Control Room:** Robocorp 的云端机器人管理与编排平台
* **Robot:** 指 Robocorp 平台上的自动化机器人程序
* **Work Item:** Robocorp 中代表一个待处理任务的最小单元
* **Attended Automation:** 机器人与人协同工作，通常由用户触发
* **Unattended Automation:** 机器人自主运行，无需人工干预，通常由调度器触发
* **Citizen Developer:** 公民开发者，指非专业程序员但能利用低代码/无代码工具开发应用的人员

---

### 2. 总体架构 (v2.0 平台化)

#### 2.1 核心理念
项目将从单一流程的自动化脚本，演进为一个前后端分离的、面向用户的 Web 平台。用户通过浏览器即可与平台交互，选择、配置并运行所需的自动化任务，并直观地看到结果。

#### 2.2 技术架构
*   **前端 (Frontend):**
    *   **框架:** React.js
    *   **描述:** 构建一个动态的、高度互动的单页应用 (SPA)。负责所有用户界面的渲染和交互。
*   **后端 (Backend):**
    *   **框架:** Flask
    *   **描述:** 作为 API 服务器，负责处理前端的请求、管理任务状态，并作为前端与 RPA 机器人之间的“桥梁”。
*   **RPA 执行引擎 (Worker):**
    *   **框架:** Robocorp
    *   **描述:** 负责执行具体的自动化业务逻辑。由后端 API 触发和调度。

---

### 3. 用户界面与功能 (Frontend)

#### 3.1 任务仪表盘 (Dashboard)
*   **需求:** 用户访问平台后，应看到一个清晰的仪表盘，以卡片形式展示所有可用的 RPA 任务“模板”。
*   **模板卡片:** 每张卡片应包含：
    *   任务名称 (如: “发票报销流程”)
    *   任务简介
    *   一个“开始任务”按钮

#### 3.2 任务执行界面
*   **需求:** 点击“开始任务”后，用户应看到一个专门用于该任务的表单或输入区域。
*   **示例 (发票报销):**
    *   一个文件上传控件，用于上传发票 PDF 或图片。
    *   一个“提交”按钮，用于启动 RPA 机器人。

#### 3.3 结果与状态展示
*   **需求:** 任务提交后，界面应能实时或准实时地展示任务的当前状态。
*   **状态:** 包括 `排队中`, `运行中`, `成功`, `失败`, `等待人工审核`。
*   **结果:** 任务成功后，应在界面上清晰地展示提取出的关键数据（如发票号码、金额、日期）。

#### 3.4 人工审核队列 (Review Queue)
*   **需求:** 对于失败或需要人工干预的任务，应提供一个专门的审核界面。
*   **功能:**
    *   列表展示所有待审核的任务。
    *   提供任务详情视图，包含原始凭证和初步提取的数据。
    *   允许用户修正数据并重新提交，或直接批准/拒绝。

### 4. 后端接口 (Backend API)
后端需提供一套 RESTful API 供前端调用。
*   `GET /api/templates`: 获取所有可用的 RPA 任务模板列表。
*   `POST /api/tasks`: 提交一个新任务，请求体中包含 `template_id` 和文件数据。返回一个唯一的 `task_id`。
*   `GET /api/tasks/{task_id}`: 根据 `task_id` 查询任务的当前状态和结果。
*   `GET /api/review-queue`: 获取需要人工审核的任务列表。
*   `POST /api/review-queue/{item_id}`: 提交人工审核的结果。

### 5. 核心 RPA 自动化功能 (Worker)
*   **多系统集成能力：**
    *   **Web 应用自动化：** 自动登录、数据抓取、表单填写、导航等。
    *   **桌面应用自动化：** 模拟鼠标点击、键盘输入、窗口操作等。
    *   **API 集成：** 直接调用各种业务系统（ERP, CRM, OA 等）的 API 接口进行数据交互。
    *   **数据库操作：** 支持主流数据库的连接、查询、写入等操作。
    *   **文件系统操作：** 文件的创建、读取、写入、移动、删除等。
    *   **邮件自动化：** 邮件的发送、接收、解析附件、内容提取等。
*   **流程编排与调度：**
    *   **任务队列管理：** 支持将自动化任务加入队列，实现任务的并行或顺序处理。
    *   **调度器：** 根据预设时间、周期或事件触发机器人运行（支持单次、每日、每周、每月等多种模式）。
    *   **工作流设计：** 利用 Robocorp Lab (或兼容的可视化设计器) 构建复杂的自动化工作流，包括条件判断、循环、错误处理等。
*   **安全与凭证管理：**
    *   **安全凭证存储：** 敏感信息（用户名、密码、API Key 等）的加密存储和安全访问。
    *   **权限管理：** 不同用户角色的权限划分（如管理员、开发者、操作员等）。
*   **监控与报告：**
    *   **实时运行监控：** 在 Robocorp Control Room 中实时查看机器人运行状态、进度。
    *   **日志记录：** 详细记录机器人运行日志，便于问题排查和审计。
    *   **告警通知：** 当机器人运行异常或失败时，通过邮件、企业微信/钉钉等方式通知相关人员。
    *   **仪表盘：** 提供...

---

### 6. RPA 流程引擎与 LLM 动态交互 (v2.1 增强)

#### 6.1 结构化流程定义 (已实现)

*   **描述:** 项目的核心是位于 `robots/workflow_executor.py` 的通用工作流执行器。它通过解析结构化的 YAML 文件来驱动 RPA 任务，实现了业务逻辑与执行代码的解耦，为未来的可视化流程设计器奠定了坚实的基础。
*   **实现方式:** 
    *   **YAML 驱动:** 采用 YAML 文件来描述流程，包含 `name`, `description`, 和 `steps` 等核心元素。
    *   **丰富的动作库 (Action Types):** 执行器支持多种操作类型，包括但不限于：
        *   `browser_goto`, `browser_fill`, `browser_click`, `browser_js_click`
        *   `browser_switch_to_frame`, `browser_wait_for_selector`, `browser_wait_for_load_state`
        *   `browser_upload_file`, `browser_login_human_like`
        *   `llm_extract` (规划中)
    *   **参数与变量:** 每个动作都支持可配置的参数，并能在步骤间通过变量传递数据。

#### 6.2 LLM 赋能动态操作 (部分实现)

*   **描述:** 平台已具备在 RPA 流程中借助 LLM 能力进行智能操作的能力，特别是在非结构化数据提取方面。
*   **已实现场景:**
    *   **非结构化数据提取:** 已实现基于本地大模型，结合双 OCR 引擎结果，从多种票据（如增值税发票、机票行程单）的复杂文本中提取结构化数据的能力。该功能高度可配置，详见 `config/invoice_configs.yaml`。
*   **未来方向:**
    *   **动态元素识别:** 当页面元素的选择器不稳定时，允许 LLM 根据页面截图和自然语言描述来动态定位目标元素。
    *   **智能判断与决策:** 根据当前业务上下文，让 LLM 判断下一步应该执行的操作，实现更高级的自动化。

#### 6.3 可配置票据处理 (已实现)

*   **描述:** 针对发票报销等文档密集型场景，平台提供了一套高度灵活的票据类型配置和内容提取框架。
*   **实现方式:**
    *   **配置文件:** 在 `config/invoice_configs.yaml` 中，可以为不同的票据类型（如“增值税专用发票”、“火车票”）定义各自的提取规则。
    *   **字段映射:** 为每种票据类型配置需要提取的关键字段及其元数据（ID, 标签, 类型, 是否必须）。
    *   **动态 Prompt 生成:** `src/ai_services.py` 中的服务会读取这些配置，并根据配置为不同的票据类型动态生成最优的 LLM Prompt。

---

### 7. 监控与报告 (v2.1 增强)

#### 7.1 任务执行日志

*   **需求:** 详细记录每个 RPA 任务的执行过程，包括每个步骤的开始、结束、输入、输出和任何错误信息。
*   **实现方式:** 将日志信息存储到后端数据库或文件系统，并通过 API 提供给前端。

#### 7.2 任务状态可视化

*   **需求:** 在前端界面上，除了最终状态，还能展示任务执行到哪个步骤，以及当前步骤的详细信息。
*   **实现方式:** 后端 API 实时更新任务的 `current_step` 和 `step_details` 字段，前端轮询并展示。

#### 7.3 告警与通知

*   **需求:** 当任务失败或转入人工审核时，能够通过邮件、企业微信/钉钉等方式通知相关人员。
*   **实现方式:** 后端集成通知服务。

---

### 8. 扩展性与维护性 (v2.1 增强)

#### 8.1 模块化设计

*   **需求:** 确保 RPA 流程、AI 服务和业务系统交互模块之间高度解耦，便于独立开发和维护。

#### 8.2 配置化管理

*   **需求:** 尽可能通过配置文件而非代码来管理业务规则、API 端点和 LLM Prompt，降低修改成本。

#### 8.3 单元测试与集成测试

*   **需求:** 为新的流程引擎、LLM 模块和 API 接口编写全面的测试用例，确保系统稳定性。

---

### 9. 安全性 (v2.1 增强)

#### 9.1 数据加密

*   **需求:** 确保敏感数据（如发票内容、提取结果）在传输和存储过程中的安全性。

#### 9.2 访问控制

*   **需求:** 虽然初期不考虑用户权限，但未来应预留用户认证和授权的扩展点。

---

### 10. 性能 (v2.1 增强)

#### 10.1 并发处理

*   **需求:** 优化后端任务调度，支持并发执行多个 RPA 任务。

#### 10.2 响应速度

*   **需求:** 确保前端界面响应迅速，后端 API 延迟低。

---

### 11. 部署 (v2.1 增强)

#### 11.1 容器化

*   **需求:** 考虑使用 Docker 等容器技术打包应用，简化部署和环境管理。

#### 11.2 生产环境配置

*   **需求:** 区分开发和生产环境配置，确保生产环境的稳定性和安全性。

---

### 12. 前端配置管理界面 (v2.2 新增)

#### 12.1 需求

*   **目标:** 允许非开发人员通过直观的前端界面，对 RPA 流程定义（YAML 文件）和发票配置（YAML 文件）进行查看、编辑和保存。
*   **功能:**
    *   **流程列表:** 展示所有已定义的 RPA 流程，并提供编辑入口。
    *   **发票配置列表:** 展示所有已定义的票据类型配置，并提供编辑入口。
    *   **YAML 编辑器:** 提供一个文本区域，用于直接编辑 YAML 内容。
    *   **保存功能:** 将修改后的 YAML 内容通过后端 API 保存回文件系统。
    *   **错误提示:** 对无效的 YAML 格式提供友好的错误提示。

#### 12.2 后端 API 扩展

*   **`GET /api/workflows/{id}`**
    -   **描述:** 获取指定 ID 的 RPA 流程的 YAML 内容。
    -   **响应 (200 OK):** YAML 字符串。

*   **`PUT /api/workflows/{id}`**
    -   **描述:** 更新指定 ID 的 RPA 流程的 YAML 内容。
    -   **请求:** `Content-Type: text/plain`，请求体为 YAML 字符串。
    -   **响应 (200 OK):** `{"message": "Workflow updated successfully."}`

*   **`GET /api/invoice-configs/{id}`**
    -   **描述:** 获取指定 ID 的发票配置的 YAML 内容。
    -   **响应 (200 OK):** YAML 字符串。

*   **`PUT /api/invoice-configs/{id}`**
    -   **描述:** 更新指定 ID 的发票配置的 YAML 内容。
    -   **请求:** `Content-Type: text/plain`，请求体为 YAML 字符串。
    -   **响应 (200 OK):** `{"message": "Invoice config updated successfully."}`

#### 12.3 前端 UI 实现

*   **导航:** 在主导航栏添加“配置管理”或“模板管理”入口。
*   **组件:**
    *   `ConfigManagement.js`: 主入口组件，包含流程和发票配置的列表。
    *   `WorkflowEditor.js`: 用于编辑单个 RPA 流程 YAML 的组件。
    *   `InvoiceConfigEditor.js`: 用于编辑单个发票配置 YAML 的组件。
*   **技术细节:**
    *   使用 `textarea` 作为 YAML 编辑器，并考虑集成代码高亮库（如 `react-simple-code-editor`）。
    *   在保存前进行基本的 YAML 格式校验。

---

### 13. 桌面版工作流录制器与智能生成 (v1.0)

#### 13.1 核心理念：桌面应用录制与同源 iframe 适配

为解决在复杂企业应用中录制用户操作的挑战，我们引入了一套基于 Electron 的桌面版录制器。该录制器旨在提供一个直观的用户界面，用于录制用户在浏览器中的操作，并自动生成可执行的 RPA 工作流 YAML 文件。它特别关注对同源 iframe 内部操作的准确捕获和记录。

#### 13.2 最终用户交互流程

**场景：用户录制一个包含同源 iframe 交互的流程**

1.  **启动录制器**: 用户在 RPA 平台中，点击左侧导航栏的“录制工作流”，进入录制器主界面。
2.  **输入目标 URL**: 用户在录制器界面输入目标网站的 URL（例如 `https://oa.topprismdata.com/seeyon/main.do`），然后点击“开始录制”。
3.  **新窗口操作**: 录制器会弹出一个新的浏览器窗口，加载目标 URL。用户在此窗口中进行操作，例如登录、点击链接、填写表单等。
4.  **同源 iframe 交互**: 如果页面中包含同源 iframe（例如 `id="zwIframe"`），用户在 iframe 内部的任何操作（如点击、输入）都将被录制器捕获。录制器能够识别这些操作发生在 iframe 内部，并记录相应的上下文信息。
5.  **实时反馈**: 在整个过程中，用户可以在录制器界面实时看到已录制的步骤列表，包括主页面和 iframe 内部的操作。
6.  **获取源代码**: 用户可以随时点击“获取源代码”按钮，获取当前页面或指定元素的 HTML 源代码，这对于调试和理解页面结构非常有帮助，特别是对于 iframe 的内容。
7.  **回放与验证**: 用户可以随时点击“回放”按钮。系统将在后台调用配置好的 `conda` 环境来执行 `robocorp` 任务，并在一个新的浏览器窗口中重放录制的步骤。用户可以通过观察浏览器的自动操作来验证录制结果的准确性。
8.  **结束录制**: 用户完成所有想录制的操作后，点击录制器界面上的“停止录制”按钮。
9.  **保存工作流**: 用户确认录制的步骤无误后，点击“保存工作流”按钮，录制器将生成一个包含所有操作（包括 iframe 切换）的 YAML 工作流文件。

#### 13.3 功能需求列表

*   **桌面应用录制器**: 提供一个独立的 Electron 桌面应用作为录制功能的核心。
    *   **启动/停止录制**: 提供清晰的按钮来控制录制过程。
    *   **目标 URL 输入**: 允许用户指定要录制的目标网站 URL。
    *   **新浏览器窗口**: 录制过程在一个独立的浏览器窗口中进行，不干扰主应用界面。
*   **智能同源 iframe 处理**: 
    *   **iframe 上下文识别**: 能够识别用户操作发生在哪个同源 iframe 内部。
    *   **自动生成 `browser_switch_to_frame`**: 在生成的 YAML 中，自动插入 `browser_switch_to_frame` 步骤，用于切换到正确的 iframe 上下文。通过 `__main_page__` 这个特殊选择器，可以方便地返回主页面。
*   **源代码获取功能**: 
    *   **获取当前页面源代码**: 允许用户获取当前浏览器窗口的完整 HTML 源代码。
    *   **获取指定元素源代码**: 允许用户通过 CSS 选择器获取特定元素的 HTML 源代码。
    *   **UI 集成**: 在录制器界面提供按钮和显示区域。
*   **步骤捕获**: 能够准确捕获并记录以下用户行为：
    *   **点击 (`click`)**: 记录被点击元素的选择器和文本内容。
    *   **输入 (`input`)**: 记录输入框的选择器和输入的值。
    *   **选择 (`select`)**: 记录下拉选择框的选择器、选中的值和文本内容。
*   **YAML 生成**: 将录制到的步骤转换为结构化、可执行的 RPA 工作流 YAML 文件。
*   **实时反馈**: 在录制器界面实时显示已录制的步骤。
*   **清空步骤**: 提供清空已录制步骤的功能。